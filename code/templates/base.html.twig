<!DOCTYPE html>
<html lang="en" data-theme="{{ user_theme|default('light') }}">
    <head>
        {# Critical: Apply theme before any rendering to prevent flash #}
        <script>
            // Mark when script execution begins (approximate parse start)
            performance.mark('theme-start');

            (function() {
                // Get theme from cookie if localStorage unavailable
                function getThemeFromCookie() {
                    const match = document.cookie.match(/theme=([^;]+)/);
                    return match ? match[1] : null;
                }

                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const systemTheme = prefersDark ? 'dark' : 'light';
                const savedTheme = localStorage.getItem('theme') ||
                                   getThemeFromCookie() ||
                                   systemTheme;
                document.documentElement.setAttribute('data-theme', savedTheme);

                // Sync cookie with current theme for server-side access
                if (!getThemeFromCookie() || getThemeFromCookie() !== savedTheme) {
                    document.cookie = `theme=${savedTheme};path=/;max-age=31536000;SameSite=Lax`;
                }

                // Mark when theme is applied
                performance.mark('theme-end');
                performance.measure('theme-application', 'theme-start', 'theme-end');

                // Log if over 10ms threshold
                const measure = performance.getEntriesByName('theme-application')[0];
                if (measure && measure.duration > 10) {
                    console.warn(`Theme application took ${measure.duration.toFixed(2)}ms (target: <10ms)`);
                }
            })();
        </script>

        <style>
            /* Critical: Prevent flash of unstyled content */
            html:not([data-theme]) {
                visibility: hidden;
                opacity: 0;
            }
            html[data-theme] {
                visibility: visible;
                opacity: 1;
                /* No transition to ensure instant visibility */
            }
            /* Optional: If smooth appearance desired, use very short duration */
            @media (prefers-reduced-motion: no-preference) {
                html[data-theme] {
                    transition: opacity 0.005s ease-out; /* 5ms max, well under 10ms target */
                }
            }
        </style>

        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>{% block title %}{{ pageTitle|default('Humble') }}{% endblock %}</title>

        <meta name="description" content="{% block description %}Modern design solutions and technical excellence{% endblock %}">
        <meta name="theme-color" content="#B180F0">
        <link rel="icon" href="/images/humble-wizard-icon.png" type="image/png">

        {% block stylesheets %}
            <link rel="stylesheet" href="{{ asset('css/app.css') }}">
        {% endblock %}
    </head>

    <body>
        <nav class="navbar" id="navbar">
            <div class="navbar-container">
                <div class="navbar-brand">
                    <a href="{{ path('home') }}" class="brand-logo">Humble</a>
                </div>

                <div class="navbar-menu" id="navbar-menu">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a href="{{ path('about') }}" class="nav-link{{ app.request.attributes.get('_route') == 'about' ? ' active' : '' }}">About</a>
                        </li>
                        <li class="nav-item">
                            <a href="{{ path('services') }}" class="nav-link{{ app.request.attributes.get('_route') == 'services' ? ' active' : '' }}">Services</a>
                        </li>
                        <li class="nav-item">
                            <a href="{{ path('coming_soon') }}" class="nav-link{{ app.request.attributes.get('_route') == 'coming_soon' ? ' active' : '' }}">Portfolio</a>
                        </li>
                        <li class="nav-item">
                            <a href="{{ path('contact') }}" class="nav-link{{ app.request.attributes.get('_route') == 'contact' ? ' active' : '' }}">Contact</a>
                        </li>
                        <li class="nav-item">
                            <button class="theme-toggle" id="theme-toggle" title="Toggle dark mode">
                                <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="5"/>
                                    <path d="m12 1 0 2m0 18 0 2M4.22 4.22l1.42 1.42m12.72 12.72 1.42 1.42M1 12l2 0m18 0 2 0M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                                </svg>
                                <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                                </svg>
                            </button>
                        </li>
                    </ul>
                </div>

                <div class="navbar-toggle" id="navbar-toggle">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </div>
            </div>
        </nav>

        <main class="main-content">
            {% block body %}{% endblock %}
        </main>

        <footer class="footer">
            <div class="footer-container">
                <p>&copy; {{ "now"|date("Y") }} Humble. All rights reserved.</p>
            </div>
        </footer>

        {% block javascripts %}
            {% block importmap %}{{ importmap('app') }}{% endblock %}
        {% endblock %}

        {# Fallback scripts - ensure functionality even if main JS fails #}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // Mobile menu toggle
                const navbarToggle = document.getElementById('navbar-toggle');
                const navbarMenu = document.getElementById('navbar-menu');

                if (navbarToggle && navbarMenu) {
                    navbarToggle.addEventListener('click', function(e) {
                        e.preventDefault();
                        navbarMenu.classList.toggle('active');
                        navbarToggle.classList.toggle('active');
                    });
                }

                // Theme toggle
                const themeToggle = document.getElementById('theme-toggle');
                if (themeToggle) {
                    themeToggle.addEventListener('click', function(e) {
                        e.preventDefault();
                        const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                        document.documentElement.setAttribute('data-theme', newTheme);
                        localStorage.setItem('theme', newTheme);
                        // Also set cookie for server-side access and no-JS fallback
                        document.cookie = `theme=${newTheme};path=/;max-age=31536000;SameSite=Lax`;
                    });
                }
            });
        </script>
    </body>
</html>
